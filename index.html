<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cicada Button</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      height: 100vh;
      margin: 0;
      background: #000;
      font-family: monospace;
      color: #888;
    }

    header, footer {
      text-align: center;
      padding: 1em;
      width: 100%;
    }

    footer a {
      color: #888;
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
      color: #aaa;
    }

    main {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1em;
    }

    button {
      background: black;
      border: none;
      padding: 0;
      cursor: pointer;
      font-family: monospace;
      text-align: left;
    }

    button:disabled {
      cursor: default;
      opacity: 0.6;
    }

    pre {
      margin: 0;
      font-size: 14px;
      line-height: 1;
      color: white;
    }

    input[type="range"] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 200px;
      height: 6px;
      background: #333;
      border-radius: 3px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
      border: 1px solid #aaa;
    }

    input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
      border: 1px solid #aaa;
    }
  </style>
</head>
<body>

  <header>
    <h1 style="font-weight: normal; font-size: 1.2em; margin: 0;">The Black Squeaker Project</h1>
  </header>

  <main>
    <button id="cicadaBtn"></button>
    <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="0.5">
  </main>

  <footer>
    <a href="https://www.eventbrite.com.au/e/the-black-squeaker-project-tickets-1487374871279" target="_blank">
View Concert & Tickets 
</a><br>
<a href="https://www.researchgate.net/publication/384767949_A_NEW_SPECIES_OF_ATRAPSALTA_OWEN_AND_MOULDS_2016_HEMIPTERA_CICADIDAE_FROM_SOUTH_AUSTRALIA" target="_blank"> 
Atrapsalta AUDAX  (Popple 2024)
</a>
  </footer>

<script>
// Audio Configuration
const CICADA_CONFIG = {
  carrier: {
    baseFreq: 10800,
    maxFreq: 13200,
    minFreq: 10800,
    oscType: "sawtooth",
    gain: 0.05,
    detuneRange: 20 // ±20 cents
  },
  tremolo: {
    startFreq: 5,
    baseFreq: 150,
    freqVariation: 10, // Random addition to baseFreq
    finalMultiplier: 1.4,
    depth: 0.05
  },
  noise: {
    bandpassFreq: 8000,
    bandpassQ: 8,
    gain: 0.06
  },
  filters: {
    lowpass: 9000,
    highpass: 3000
  },
  timing: {
    minBursts: 6,
    maxBursts: 12,
    burstDuration: 0.6,
    burstVariation: 0.15, // ±15%
    gapDuration: 0.2,
    gapVariation: 0.2, // ±20%
    alternateChance: 0.2, // 20% chance
    alternateLongBurst: {
      minDuration: 4,
      maxDuration: 6,
      variation: 0.05
    },
    alternateShortBurst: {
      duration: 0.3,
      variation: 0.15
    }
  }
};

let audioCtx;
let carrierFrequency;

// Update carrier frequency calculation using config
window.addEventListener('load', () => {
  carrierFrequency = CICADA_CONFIG.carrier.baseFreq + 
    Math.random() * (CICADA_CONFIG.carrier.maxFreq - CICADA_CONFIG.carrier.minFreq);
});

const btn = document.getElementById('cicadaBtn');

const normalPre = `
<pre>
   ._.
  (} {)
  /\\ /\\
 /| | |\\
 | \\ / |
 |_/V\\_|
</pre>
`;

const playingPre = `
<pre>
   ._.
  (} {)
  /\\ /\\
 /|/~\\|\\
( /\\~/\\ )
    V 
</pre>
`;

btn.innerHTML = normalPre;

function playCicada() {
  const burstCount = CICADA_CONFIG.timing.minBursts + 
    Math.floor(Math.random() * (CICADA_CONFIG.timing.maxBursts - CICADA_CONFIG.timing.minBursts));
    
  // Helper to vary a value by ±percentage
  const vary = (value, amount = 0.1) => value * (1 + (Math.random() * 2 - 1) * amount);

  // Generate slightly different durations for each burst and gap
  const burstDurations = Array.from({ length: burstCount }, () => vary(0.6, 0.15)); // ±15%
  const gaps = Array.from({ length: burstCount }, () => vary(0.2, 0.2));             // ±20%

  createCicadaSound({
    burstCount,
    burstDurations,
    gaps
  });
}

function playAlternateCicada() {
  const longBurstDuration = 4 + Math.random() * 2; // 4–6s

  const vary = (value, amount = 0.1) => value * (1 + (Math.random() * 2 - 1) * amount);

  // Each burst and gap gets slight individual variation
  const burstDurations = [
    vary(longBurstDuration, 0.05), // keep long one mostly stable
    ...Array.from({ length: 4 }, () => vary(0.3, 0.15)) // ±15% for shorter bursts
  ];

  const gaps = Array.from({ length: 5 }, () => vary(0.2, 0.2)); // ±20%

  createCicadaSound({
    burstCount: 5,
    burstDurations,
    gaps
  });
}

function createCicadaSound({ burstCount, burstDuration, gap, burstDurations, gaps }) {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const now = audioCtx.currentTime;

  // Master gain
  const master = audioCtx.createGain();
  master.gain.value = document.getElementById('volumeControl').value;
  master.connect(audioCtx.destination);

  // Carrier oscillator
  const osc = audioCtx.createOscillator();
  osc.type = CICADA_CONFIG.carrier.oscType;
  osc.frequency.value = carrierFrequency;
  const oscGain = audioCtx.createGain();
  oscGain.gain.value = CICADA_CONFIG.carrier.gain;
  osc.connect(oscGain);

  // Tremolo
  const lfo = audioCtx.createOscillator();
  lfo.type = "square";
  const lfoGain = audioCtx.createGain();
  lfoGain.gain.value = CICADA_CONFIG.tremolo.depth;
  lfo.connect(lfoGain);
  lfoGain.connect(oscGain.gain);

  // Noise
  const bufferSize = 2 * audioCtx.sampleRate;
  const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = noiseBuffer.getChannelData(0);
  for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
  const noise = audioCtx.createBufferSource();
  noise.buffer = noiseBuffer;
  noise.loop = true;
  const noiseFilter = audioCtx.createBiquadFilter();
  noiseFilter.type = "bandpass";
  noiseFilter.frequency.value = CICADA_CONFIG.noise.bandpassFreq;
  noiseFilter.Q.value = CICADA_CONFIG.noise.bandpassQ;
  const noiseGain = audioCtx.createGain();
  noiseGain.gain.value = CICADA_CONFIG.noise.gain;
  noise.connect(noiseFilter);
  noiseFilter.connect(noiseGain);

  // Burst LP filter
  const lpFilter = audioCtx.createBiquadFilter();
  lpFilter.type = "lowpass";

  // Overall LP & HP filters
  const overallLP = audioCtx.createBiquadFilter();
  overallLP.type = "lowpass";
  overallLP.frequency.value = CICADA_CONFIG.filters.lowpass;
  const overallHP = audioCtx.createBiquadFilter();
  overallHP.type = "highpass";
  overallHP.frequency.value = CICADA_CONFIG.filters.highpass;

  // Set up modulation chain
  lfoGain.connect(oscGain.gain);    // Tremolo modulates carrier
  lfoGain.connect(noiseGain.gain);  // Tremolo also modulates noise

  // Carrier path
  osc.connect(oscGain);
  oscGain.connect(lpFilter);        // Sweep filter for carrier

  // Noise path
  noise.connect(noiseFilter);       // Bandpass first
  noiseFilter.connect(noiseGain);
  noiseGain.connect(lpFilter);      // Through same sweep filter

  // Final mixing chain
  lpFilter.connect(overallLP);      // Sweep -> LP
  overallLP.connect(overallHP);     // LP -> HP
  overallHP.connect(master);        // HP -> Master

  // Compute durations
  const durations = burstDurations || Array(burstCount).fill(burstDuration);
  const gapsArr = gaps || Array(burstCount).fill(gap);

  let t = now;
  for (let i = 0; i < burstCount; i++) {
    const start = t;
    const end = start + durations[i];

    // Amplitude envelope
    master.gain.setValueAtTime(0, start);
    master.gain.linearRampToValueAtTime(document.getElementById('volumeControl').value, start + 0.02);
    master.gain.setValueAtTime(document.getElementById('volumeControl').value, end - 0.02);
    master.gain.linearRampToValueAtTime(0, end);

    // LP filter sweep
    lpFilter.frequency.setValueAtTime(7000, start);
    lpFilter.frequency.linearRampToValueAtTime(15000, end);

    // Detune
    const detune = (Math.random() - 0.5) * 20;
    osc.detune.setValueAtTime(detune, start);

    // Tremolo warm-up
    const baseFreq = 120 + Math.random() * 10;
    const finalFreq = baseFreq * 1.2;
    lfo.frequency.setValueAtTime(5, start);
    lfo.frequency.linearRampToValueAtTime(baseFreq, start + 0.1);
    lfo.frequency.setValueAtTime(baseFreq, start + 0.2);
    lfo.frequency.linearRampToValueAtTime(finalFreq, end);

    t = end + gapsArr[i];
  }

  osc.start(now);
  lfo.start(now);
  noise.start(now);

  osc.stop(t);
  lfo.stop(t);
  noise.stop(t);
}

// Handle button press
btn.addEventListener('click', () => {
  btn.disabled = true;
  btn.innerHTML = playingPre;

  if (Math.random() < CICADA_CONFIG.timing.alternateChance) {
    playAlternateCicada();
  } else {
    playCicada();
  }

  // Re-enable button after 5–15s
  const delay = 5000 + Math.random() * 10000;
  setTimeout(() => {
    btn.disabled = false;
    btn.innerHTML = normalPre;
  }, delay);
});
</script>
</body>
</html>
